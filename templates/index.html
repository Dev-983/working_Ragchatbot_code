<!DOCTYPE html>
<html lang="en">
<head>
  <title>Gemni API</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script
  >
  <style>
* {
    box-sizing: border-box;
}

body {
    margin: 0;
    font-family: Arial, sans-serif;
}

.container {
    display: flex;
    height: 750px;width: 100%;
}

.left {
    width: 20%;
    background-color: black;color: white;
    padding: 20px;
}

.right {
    width: 80%;
    background-color: #ada8a859;color: white;
    padding: 20px;
}
        /* Loader style */
        #loader,#loader2 {
            border: 16px solid #f3f3f3; /* Light grey */
            border-top: 16px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
            display: none; /* Hidden by default */
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* MODAL */
        /* Modal styles */

body{
  background-color: black; color: white;
  width: 100%;
  height: 100%;
}
 #success_tic .page-body{
  max-width:300px;
  background-color:#FFFFFF;
  margin:10% auto;
}
 #success_tic .page-body .head{
  text-align:center;
}
/* #success_tic .tic{
  font-size:186px;
} */
#success_tic .close{
      opacity: 1;
    position: absolute;
    right: 0px;
    font-size: 30px;
    padding: 3px 15px;
  margin-bottom: 10px;
}
#success_tic .checkmark-circle {
  width: 150px;
  height: 150px;
  position: relative;
  display: inline-block;
  vertical-align: top;
}
.checkmark-circle .background {
  width: 150px;
  height: 150px;
  border-radius: 50%;
  background: #1ab394;
  position: absolute;
}
#success_tic .checkmark-circle .checkmark {
  border-radius: 5px;
}
#success_tic .checkmark-circle .checkmark.draw:after {
  -webkit-animation-delay: 300ms;
  -moz-animation-delay: 300ms;
  animation-delay: 300ms;
  -webkit-animation-duration: 1s;
  -moz-animation-duration: 1s;
  animation-duration: 1s;
  -webkit-animation-timing-function: ease;
  -moz-animation-timing-function: ease;
  animation-timing-function: ease;
  -webkit-animation-name: checkmark;
  -moz-animation-name: checkmark;
  animation-name: checkmark;
  -webkit-transform: scaleX(-1) rotate(135deg);
  -moz-transform: scaleX(-1) rotate(135deg);
  -ms-transform: scaleX(-1) rotate(135deg);
  -o-transform: scaleX(-1) rotate(135deg);
  transform: scaleX(-1) rotate(135deg);
  -webkit-animation-fill-mode: forwards;
  -moz-animation-fill-mode: forwards;
  animation-fill-mode: forwards;
}
#success_tic .checkmark-circle .checkmark:after {
  opacity: 1;
  height: 75px;
  width: 37.5px;
  -webkit-transform-origin: left top;
  -moz-transform-origin: left top;
  -ms-transform-origin: left top;
  -o-transform-origin: left top;
  transform-origin: left top;
  border-right: 15px solid #fff;
  border-top: 15px solid #fff;
  border-radius: 2.5px !important;
  content: '';
  left: 35px;
  top: 80px;
  position: absolute;
}

@-webkit-keyframes checkmark {
  0% {
    height: 0;
    width: 0;
    opacity: 1;
  }
  20% {
    height: 0;
    width: 37.5px;
    opacity: 1;
  }
  40% {
    height: 75px;
    width: 37.5px;
    opacity: 1;
  }
  100% {
    height: 75px;
    width: 37.5px;
    opacity: 1;
  }
}
@-moz-keyframes checkmark {
  0% {
    height: 0;
    width: 0;
    opacity: 1;
  }
  20% {
    height: 0;
    width: 37.5px;
    opacity: 1;
  }
  40% {
    height: 75px;
    width: 37.5px;
    opacity: 1;
  }
  100% {
    height: 75px;
    width: 37.5px;
    opacity: 1;
  }
}
@keyframes checkmark {
  0% {
    height: 0;
    width: 0;
    opacity: 1;
  }
  20% {
    height: 0;
    width: 37.5px;
    opacity: 1;
  }
  40% {
    height: 75px;
    width: 37.5px;
    opacity: 1;
  }
  100% {
    height: 75px;
    width: 37.5px;
    opacity: 1;
  }
}
/*  CHATBOT */

.chat-container {
   * width: 400px;
    color: white;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    background-color: black;
}

.chat-header {
    background-color: #0c3a2d;
    color: white;
    padding: 15px;
    text-align: center;
}

.chat-body {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    border-bottom: 1px solid #ddd;
    font-size: 16px;font-family: sans-serif;
}

.chat-footer {
    display: flex;
    padding: 10px;
    border-top: 1px solid #ddd;
}

.chat-footer textarea {
    flex: 1;color: black;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-right: 10px;
    resize: none;
    height: 50px; /* Adjust height as needed */
}

.chat-footer button {
    padding: 10px 20px;
    border: none;
    background-color: #4CAF50;
    color: white;
    border-radius: 4px;
    cursor: pointer;
}

.chat-footer button:hover {
    background-color: #45a049;
}

.message {
    margin-bottom: 10px;
}

.message.user {
    text-align: right;
    padding: 20px;
    box-shadow:
    inset 0 -3em 3em rgb(0 200 0 / 30%),
    0 0 0 2px white,
    0.3em 0.3em 1em rgb(200 0 0 / 60%);
}

.message.bot {
    text-align: left;
    padding: 20px;
  box-shadow:
    inset 0 -3em 3em rgb(0 200 0 / 30%),
    0 0 0 2px white,
    0.3em 0.3em 1em rgb(200 0 0 / 60%);
}
.text-large {
  font-size: 20px;padding-right: 20px;
}
.hrline{height: 1px; background: black;}

.toggle-content {
    display: none;
}
.icon {
    cursor: pointer;
    font-size: 24px;
 margin-right: 10px;
}
/* ANIMATION */
.animated-text {
    font-size: 24px;
    font-weight: bold;
    display: inline-block;
}

.changeable-text {
    animation: changeText 6s infinite;
}

@keyframes changeText {
    0% {
        content: 'pdf';
    }
    33% {
        content: 'csv';
    }
    66% {
        content: 'url';
    }
    100% {
        content: 'excel';
    }
}

/* Fallback for older browsers */
.changeable-text:before {
    content: 'pdf';
    animation: changeText 6s infinite;
}

@keyframes changeText {
    0% {
        content: 'pdf';
    }
    33% {
        content: 'csv';
    }
    66% {
        content: 'url';
    }
    100% {
        content: 'excel';
    }
}

  </style>

<body>
    <!--
<nav class="navbar navbar-inverse">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>                        
      </button>
      
    </div>
    <div class="collapse navbar-collapse" id="myNavbar">
      <ul class="nav navbar-nav">
     
        <li class="active"><a href="#">PDF CHAT</a></li>
      </ul>

    </div>
  </div>
</nav>-->
<!-- LOADER  -->
<div id="loader"></div>
<button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#success_tic" style="display: none;"  id="modalbtn">Open Modal</button>

<!-- Modal SUCCESS -->
<div id="success_tic" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
<div class="modal-content">
    <a class="close" href="#" data-dismiss="modal">&times;</a>
    <div class="page-body">
    <div class="head">  
      <h3 style="margin-top:5px;">Success</h3>
      <h4>Let Start Chat....!</h4>
    </div>

    <h1 style="text-align:center;"><div class="checkmark-circle">
    <div class="background"></div>
    <div class="checkmark draw"></div>
</div>

  </div>
</div>
    </div>

</div>
<!-- URL MODAL -->
 <div class="modal" id="scrapeModal">
        <div class="modal-dialog">
            <div class="modal-content">

                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title">Scrape HTML Content</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>

                <!-- Modal Body -->
                <div class="modal-body">
                    
                    <div id="modalContent">
                        <div id="loader2"></div>
                        <p id="result" class="mt-3"></p>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                </div>

            </div>
        </div>
    </div>

<!--  -->
<div class="container">

    <div class="left">
        <h1>Upload Files </h1>
        <form id="uploadForm" enctype="multipart/form-data">
            <input class="form-control" type="file" id="formFile" name="file" accept=".pdf">
            <input type="submit" value="Upload" class="btn btn-primary" style="width:100%;margin-top: 10px;">
        </form>
<hr class='hrline'>
        <div id="sessionStorageContent" class="mt-3" style="margin-top: 12px;">
            <button id="clearButton" class="btn btn-info">Clear Session Storage</button>
        </div>
<hr class='hrline'>
Uploaded Files - 
    <ul>
    {% for file in files %}
    <li style='color: white;'>{{ file }}</li><button class="btn btn-danger" onclick="deleteFile(`{{ file }}`)">Delete</button>
    {% endfor %}
    </ul>
</div>


    <div class="right">
    <div class="chat-container">
        <div class="chat-header">
            <div class="animated-text">
                Chat With <span class="changeable-text"></span>
            </div>
        </div>
        <div class="chat-body" id="chatBody">
            <!-- Messages will be displayed here -->
        </div>
		<div class="chat-footer">
    		<textarea id="userInput" placeholder="Type your message here..."></textarea>
    		<button id="sendBtn">Send</button>
		</div>
    </div>	
  </div>
</div>
</body>
 <script>
// delete
function deleteFile(filename) {
    fetch(`/delete/${filename}`, { method: 'DELETE' })
         .then(response => {
        if (response.status === 204) {
            alert("SUCCESSFULLY DELETE");
            location.reload();
            //loadFiles();
        } else {
            alert('Failed to delete file');
        }
     });
}

    //Referecne result show
        let toggleCount = 0;

        function toggleDiv(divId) {
            var content = document.getElementById(divId);
            if (content.style.display === "none" || content.style.display === "") {
                content.style.display = "block";
            } else {
                content.style.display = "none";
            }
        }

        function addNewToggle(referenceText) {
            toggleCount++;
            const newIcon = document.createElement('span');
            newIcon.className = 'icon';
            newIcon.innerHTML = '🔍';
            newIcon.setAttribute('onclick', `toggleDiv('content${toggleCount}')`);

            const newDiv = document.createElement('div');
            newDiv.id = `content${toggleCount}`;
            newDiv.className = 'toggle-content';
            newDiv.innerHTML = referenceText;

            // Append new elements to the chat body
            $("#chatBody").append(newIcon);
            $("#chatBody").append(newDiv);
        }
// Upload pdf and embedding 
$(document).ready(function () {
    $('#uploadForm').on('submit', function (e) {
        e.preventDefault();
        var formData = new FormData(this);
        console.log(formData);
        $('#loader').show();

        $.ajax({
            url: '{{ url_for("uploader") }}',  // Ensure this matches the Flask endpoint
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (data) {
                console.log("SUCCESSFULLY");
                $('#loader').hide();
                $('#modalbtn').click();
                sessionStorage.clear();

            let content = "PDF session data - <button onclick='clearsession();'> Delete </button>"
            $("#sessionStorageContent").html(content);
                //console.log(data);

                const jsonData = JSON.stringify(data);

                // Calculate the size of the data in bytes
                const dataSizeInBytes = new TextEncoder().encode(jsonData).length;

                // Convert bytes to megabytes
                const dataSizeInMB = dataSizeInBytes / (1024 * 1024);

                // Check if the size exceeds 10MB
                const maxSizeInMB = 10;
                if (dataSizeInMB > maxSizeInMB) {
                    console.log(`Data size (${dataSizeInMB.toFixed(2)} MB) exceeds the limit of ${maxSizeInMB} MB.`);
                } else {
                    console.log(`Data size (${dataSizeInMB.toFixed(2)} MB) is within the limit of ${maxSizeInMB} MB.`);
                    sessionStorage.setItem('data', jsonData);
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.log('Error:', textStatus, errorThrown);
                $('#loader').hide();
            }
        });
    });
});
</script>
<script type="text/javascript">
    // CHAT Function
function formatStringToHTML(inputString) {
    // Replace patterns like **abcd** with <h4>abcd</h4>
    let formattedString = inputString.replace(/\*\*(.*?)\*\*/g, '<h4>$1</h4>');

    // Replace each occurrence of the pattern with a line break before the <h4> tag
    formattedString = formattedString.replace(/<h4>/g, '<br><h4>');

    // Replace double quotes with single quotes
    const finalString = formattedString.replace(/"/g, "'");

    return finalString;
}
$(document).ready(function() {
    $("#sendBtn").click(function() {
        var userInput = $("#userInput").val();
        if (userInput.trim() !== "") {
            // Add user's message to chat body
            $("#chatBody").append('<div class="message user"><i class="fas fa-user padding-right-md text-large"></i>' + userInput + '</div>');
            
            // Clear the input field
            $("#userInput").val('');
            var data = sessionStorage.getItem("data");
            if(data){
            // Send the message to the backend and get the response
            $.ajax({
    url: '/chat',
    type: 'POST',
    contentType: 'application/json',
    data: JSON.stringify({ message: userInput, data: data }),
    success: function(response) {
        var botResponse = formatStringToHTML(response.response);
        var reference = response.reference;

        var index = 0;
        var speed = 20;
        var botMessageId = 'botMessage' + Date.now();
        var messageContainer = $('<div class="message bot"><i class="fas fa-robot text-large"></i><span id="' + botMessageId + '"></span></div>');

        $("#chatBody").append(messageContainer);
        $("#sendBtn").prop("disabled", true);

        function streamHTML() {
            if (index < botResponse.length) {
                // Accumulate the HTML content
                let htmlToAppend = botResponse.substring(0, index);
                $("#" + botMessageId).html(htmlToAppend); // Use the dynamically created ID
                index++;
                setTimeout(streamHTML, speed);
            } else {
                $("#sendBtn").prop("disabled", false);
            }
        }
        streamHTML();

        addNewToggle(reference);

        // Scroll to the bottom of the chat body
        $("#chatBody").scrollTop($("#chatBody")[0].scrollHeight);
    }
});
        	}else{

        	$.ajax({
                url: '/chat_2',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ message: userInput}),
                success: function(response) {
                    var botResponse = formatStringToHTML(response.response);
                    var index = 0;
                    var speed = 20;
                    var messageContainer = $('<div class="message bot"><i class="fas fa-robot text-large"></i><span id="botMessage"></span></div>');

                    $("#chatBody").append(messageContainer);
                    $("#sendBtn").prop("disabled", true);

        function streamHTML() {
            if (index < botResponse.length) {
                // Accumulate the HTML content
                let htmlToAppend = botResponse.substring(0, index);
                $("#botMessage").html(htmlToAppend);
                index++;
                setTimeout(streamHTML, speed);
            } else {
                $("#sendBtn").prop("disabled", false);
            }
        }
        streamHTML();
                    // $("#chatBody").append('<div class="message bot">' + botResponse + '</div>');
                    
                    // Scroll to the bottom of the chat body
                    $("#chatBody").scrollTop($("#chatBody")[0].scrollHeight);
                }
            });
        	}


        }
    });

    // Allow pressing Enter key to send message
    $("#userInput").keypress(function(e) {
        if (e.which == 13 && !e.shiftKey) {
            e.preventDefault();
            $("#sendBtn").click();
        }
    });
});
// check session storage
 document.addEventListener('DOMContentLoaded', function() {
    var embedContent = sessionStorage.getItem('data');
    var embedDiv = document.getElementById('sessionStorageContent');
    var clearButton = document.getElementById('clearButton');

    if (embedContent) {
        embedDiv.innerHTML = "Session Data<button onclick='clearsession()'>clear</button>";
        clearButton.style.display = 'block';
    }

        clearButton.addEventListener('click', function() {
        sessionStorage.clear();
        embedDiv.textContent = '';
        clearButton.style.display = 'none';
    });
});



// clear session storage
function clearsession(){
	alert("Session data are deleted.")
	sessionStorage.clear();
	location.reload();
}
</script>
<script type="text/javascript">
    	// Success modal
var modal = document.getElementById("successModal");

// Get the button that opens the modal
var btn = document.getElementById("showModalBtn");

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("close")[0];

// When the user clicks the button, open the modal 
// btn.onclick = function() {
//     modal.style.display = "block";
// }

// When the user clicks on <span> (x), close the modal
// span.onclick = function() {
//     modal.style.display = "none";
// }

// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
    if (event.target == modal) {
        modal.style.display = "none";
    }
}
// check url formate
function check_url_formate(url){
    var urlPattern = new RegExp('^(https?:\\/\\/)?' + // protocol
                    '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.?)+[a-z]{2,}|' + // domain name
                    '((\\d{1,3}\\.){3}\\d{1,3}))' + // OR ip (v4) address
                    '(\\:\\d+)?' + // port
                    '(\\/[-a-z\\d%_.~+]*)*' + // path
                    '(\\?[;&a-z\\d%_.~+=-]*)?' + // query string
                    '(\\#[-a-z\\d_]*)?$', 'i'); // fragment locator

    if(urlPattern.test(url)) {
        return 'VALID';
    } else {
        return 'URL format is not valid.';
    }
}

// check url is valid or not

// URL MODAL OPERATION
  $(document).ready(function() {
            $('#userInput').on('paste', function(event) {
                setTimeout(function() {
                    $("#sendBtn").prop("disabled", true);
                    let url = $('#userInput').val();
                    let url_fomrate = check_url_formate(url);
                    if(url_fomrate  ==  'VALID')
                    {       $('#loader').show();
                         $.ajax({
                                url: '/check_url',
                                type: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify({ url: url }),
                                success: function(response) {
                                    $("#sendBtn").prop("disabled", false);
                                    console.log(response.message)
                                    $('#loader').hide();
                                    const result = response.message;
                                    if(result == 'ok')
                                    {
                                        $('#scrapeModal').modal('show');
                                        $('#result').html("<h3 style='color:GREEN;'>URL IS VALID</h3><button onclick='scrapbtn();' class='btn'>Scrap</button>");
                                        
                                    }
                                   
                                },
                                error: function() {
                                     $('#scrapeModal').modal('show');
                                     $('#result').html("<h3 style='color:red;'>URL IS INVALID</h3>");
                                    }
                                });
                       

                    }else{
                       $("#sendBtn").prop("disabled", false); 
                    }


                }, 100);
            });
        });
// SCRAP BTN
function scrapbtn(){
    let url = $('#userInput').val();
    $("#sendBtn").prop("disabled", true);
    if(url){
        $('#scrapeModal').modal('hide');
        $('#loader').show(); 
        $.ajax({
            url: '/scrapehtml',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ url: url }),
            success: function(response) {
                $('#loader').hide();
                $('#modalbtn').click();
                $("#sendBtn").prop("disabled", false);
                var data = response;
                console.log(data);
                sessionStorage.clear();
                let content = "URL session data - <button onclick='clearsession();'> Delete </button>"
                $("#sessionStorageContent").html(content);
                //console.log(data);
                const jsonData = JSON.stringify(data);
                const dataSizeInBytes = new TextEncoder().encode(jsonData).length;
                const dataSizeInMB = dataSizeInBytes / (1024 * 1024);
                const maxSizeInMB = 10;
                if (dataSizeInMB > maxSizeInMB) {
                    console.log(`Data size (${dataSizeInMB.toFixed(2)} MB) exceeds the limit of ${maxSizeInMB} MB.`);
                } else {
                    console.log(`Data size (${dataSizeInMB.toFixed(2)} MB) is within the limit of ${maxSizeInMB} MB.`);
                    sessionStorage.setItem('data', jsonData);
                }

            },
            error: function(error) {
                $('#loader').hide();
                $("#sendBtn").prop("disabled", false);
                alert("some error are comes");

            }
        });

    }
}
//Image Preview

</script>
</html>